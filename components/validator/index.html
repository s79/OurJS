<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Form Validation</title>
<script src="../../dev.js"></script>
<script src="../../scripts/framework.js"></script>
<script src="../../src/addons/logger.js"></script>
<style>
  /* 表单 */
form { position: relative; }
table { table-layout: fixed; width: 600px; }
col.key { width: 100px; }
col.value { width: 210px; }
th,
td { border-color: gainsboro; }
th { text-align: right; }
th.submit { text-align: center; }
textarea { resize: none; }
  /* 提示信息 */
p.validating,
p.hint { border: 1px solid #BCE8F1; background: #D9EDF7; color: #3A87AD; }
p.valid { border: 1px solid #D6E9C6; background: #DFF0D8; color: #468847; }
p.invalid { border: 1px solid #EED3D7; background: #F2DEDE; color: #B94A48; }
td p { display: none; float: left; margin: 0; padding: 3px 10px; border-radius: 2px; font-size: 12px; line-height: 1; }
td.hint p.hint,
td.valid p.valid,
td.validating p.validating,
td.invalid p.invalid { display: block; }
td.hint p.valid,
td.hint p.validating,
td.hint p.invalid,
td.validating p.valid,
td.validating p.invalid { display: none; }
  /* 密码强度 */
dl { margin: 2px 0; font-size: 12px; }
dt { float: left; padding-right: 5px; font-weight: normal; }
dd { float: left; padding: 0 10px; background: gainsboro; color: silver; }
dl.weak .weak { background: orangered; }
dl.medium .weak,
dl.medium .medium { background: gold; }
dl.strong dd { background: lime !important; }
dl.weak .weak,
dl.medium .medium,
dl.strong .strong { color: #333; font-weight: bold; }
</style>
</head>
<body>
<div id="content">
  <h1>表单验证</h1>

  <h2>Form Validation</h2>
  <fieldset>
    <legend>表单验证</legend>
    <form id="form" method="get" action="/">
      <div id="logger"></div>
      <table id="form_table">
        <colgroup>
          <col class="key">
          <col class="value">
          <col class="message">
        </colgroup>
        <tbody>
          <tr>
            <th>帐号：</th>
            <td><input name="account" type="text" value=""></td>
            <td>
              <p class="hint">请输入 3 - 20 字的帐号名</p>
              <p class="validating">验证中……</p>
              <p class="valid">√ 可以使用</p>
              <p class="invalid"></p>
            </td>
          </tr>
          <tr>
            <th>密码：</th>
            <td>
              <input name="password" type="text">
              <dl id="password_strength">
                <dt>密码强度</dt>
                <dd class="weak">弱</dd>
                <dd class="medium">中</dd>
                <dd class="strong">强</dd>
              </dl>
            </td>
            <td>
              <p class="hint">请输入密码</p>
              <p class="valid">√</p>
              <p class="invalid"></p>
            </td>
          </tr>
          <tr>
            <th>重复密码：</th>
            <td><input name="password_confirm" type="password"></td>
            <td>
              <p class="hint">请重复输入密码以确保您刚才没有输错</p>
              <p class="valid">√</p>
              <p class="invalid"></p>
            </td>
          </tr>
          <tr>
            <th>EMail：</th>
            <td><input name="email" type="text"></td>
            <td>
              <p class="hint">请输入您的 EMail 地址</p>
              <p class="valid">√</p>
              <p class="invalid"></p>
            </td>
          </tr>
          <tr>
            <th>年龄：</th>
            <td><input name="age" type="text" value="28"></td>
            <td>
              <p class="hint">请输入年龄</p>
              <p class="valid">√</p>
              <p class="invalid"></p>
            </td>
          </tr>
          <tr>
            <th>操作系统：</th>
            <td>
              <select name="os">
                <option value="" selected>请选择</option>
                <option value="Win98">Win98</option>
                <option value="WinXP">WinXP</option>
                <option value="Win7">Win7</option>
                <option value="MacOS">MacOS</option>
              </select>
            </td>
            <td>
              <p class="valid">√</p>
              <p class="invalid"></p>
            </td>
          </tr>
          <tr>
            <th>玩过的游戏：</th>
            <td>
              <select name="games" size="8" multiple>
                <option value="pal">仙剑奇侠传</option>
                <option value="tomb">古墓丽影</option>
                <optgroup label="Blizzard">
                  <option value="sc" selected>星际争霸</option>
                  <option value="wow" selected disabled>魔兽世界</option>
                </optgroup>
                <optgroup label="id Software" disabled>
                  <option value="doom" selected>毁灭战士</option>
                  <option value="quake" selected>雷神之锤</option>
                </optgroup>
              </select>
            </td>
            <td>
              <p class="valid">√</p>
            </td>
          </tr>
          <tr>
            <th>喜欢的颜色：</th>
            <td>
              <label><input name="colors" value="红色" type="checkbox">红色</label>
              <label><input name="colors" value="绿色" type="checkbox">绿色</label>
              <label><input name="colors" value="蓝色" type="checkbox">蓝色</label>
            </td>
            <td>
              <p class="valid">√</p>
              <p class="invalid"></p>
            </td>
          </tr>
          <tr>
            <th>喜欢的数字：</th>
            <td>
              <label><input name="numbers" value="一" type="radio" checked disabled>一</label>
              <label><input name="numbers" value="二" type="radio">二</label>
              <label><input name="numbers" value="三" type="radio">三</label><br>
              <label><input name="numbers" value="四" type="checkbox" checked disabled>四</label>
              <label><input name="numbers" value="五" type="checkbox">五</label>
              <label><input name="numbers" value="六" type="checkbox">六</label><br>
              <select name="numbers" disabled>
                <option value="">这里也能选</option>
                <option value="七" selected>七</option>
                <option value="八">八</option>
                <option value="九">九</option>
              </select>
              <input name="numbers" type="text" value="">
            </td>
            <td>
              <p class="hint">多类型混合的表单域</p>
              <p class="valid">√</p>
              <p class="invalid"></p>
            </td>
          </tr>
          <tr>
            <th>自我介绍：</th>
            <td><textarea name="description" rows="5" cols="25">普通玩家</textarea></td>
            <td>
              <p class="hint">请输入 20 字以内的自我介绍</p>
              <p class="valid">√</p>
              <p class="invalid"></p>
            </td>
          </tr>
          <tr>
            <th colspan="3" class="submit">
              <button type="reset">复位表单</button>
              <button id="btn_submit" type="submit">确定提交</button>
            </th>
          </tr>
        </tbody>
      </table>
    </form>
  </fieldset>
  <script>
  execute(function($) {
//--------------------------------------------------[输出日志]
    var logger = new Logger($('#logger').setStyles({float: 'right', width: 343, height: $('#form_table').offsetHeight - 2}), true);

//--------------------------------------------------[密码强度检测]
    var repeatedCharactersPattern = /(.)\1+/g;
    var getPasswordStrengthScore = function(password) {
      var score = 0;
      // 以密码包含的，各字符类型所包含的字符种类之和作为底数。
      var types = [0, 0, 0, 0];
      var charCode;
      var n = password.length;
      while (n) {
        charCode = password.charCodeAt(--n);
        if (charCode >= 48 && charCode <= 57) {
          types[0] = 10;
        } else if (charCode >= 65 && charCode <= 90) {
          types[1] = 26;
        } else if (charCode >= 97 && charCode <= 122) {
          types[2] = 26;
        } else {
          types[3] = 32;
        }
      }
      var base = types[0] + types[1] + types[2] + types[3];
      // 以密码长度作为指数。
      var exponent = password.length;
      var repeatedCharacters = password.match(repeatedCharactersPattern);
      if (repeatedCharacters) {
        repeatedCharacters.forEach(function(match) {
          // n 个连续字符按 1 + n * 0.2 个字符计算。
          exponent -= (match.length - 1) * .8;
        });
      }
      return Math.floor(Math.pow(base, exponent));
    };

//--------------------------------------------------[表单验证]
    var $form = $('#form');

    // 密码强度检测。
    // 中等强度密码参考分值，由 6 位包含小写字母和大写字母的字符组成，且其中没有连续的重复字符。
    var mediumValue = Math.pow(52, 6);
    // 高强度密码参考分值，由 8 位包含数字、小写字母、大写字母和标点符号的字符组成，且其中没有连续的重复字符。
    var strongValue = Math.pow(94, 8);
    var $passwordStrength = $('#password_strength');
    $($form.elements.password).on('input', function(e) {
      var score = getPasswordStrengthScore(this.value);
      $passwordStrength.className = score >= strongValue ? 'strong' : (score >= mediumValue ? 'medium' : (score > 1 ? 'weak' : ''));
    });

    // 显示提示信息。
    var textControls = ['text', 'password', 'textarea'];
    var getMessageBox = function(name) {
      var control = $form.elements[name];
      control = control.nodeType ? control : control[0];
      var $parent = control;
      while ($parent && $parent.nodeName !== 'TD') {
        $parent = $parent.getParent();
      }
      return $parent.getNextSibling();
    };
    $form
        .on('focusin, focusout', function(e) {
          var $target = e.target;
          var name = $target.name;
          var controlType = name ? $target.type : undefined;
          if (textControls.contains(controlType)) {
            getMessageBox(name)[e.type === 'focusin' ? 'addClass' : 'removeClass']('hint');
          }
        })
        .on('reset', function() {
          Object.forEach(this.validationRulesets, function(rule, name) {
            getMessageBox(name).removeClass('hint, valid, invalid');
          });
          $passwordStrength.removeClass('weak, medium, strong');
        });

    // 添加验证规则。
    $form
        .setValidationRules({
          account: {
            required: [true, '请输入帐号'],
            minLength: [3, '帐号应在 3 位以上'],
            maxLength: [20, '帐号应在 20 位以内'],
            remote: {
              url: 'validator.txt',
              config: {
                useCache: false,
                minTime: 1000,
                requestParser: function(data) {
                  return 'value=' + data;
                },
                responseParser: function(data) {
                  var value = $('#form').elements.account.value;
                  return {errorMessage: value.startsWith('our') ? '' : JSON.parse(data.text).errorMessage + '（以 our 开头即可通过验证）'};
                }
              }
            }
          },
          password: {
            required: [true, '请输入密码']
          },
          'password_confirm': {
            equals: ['password', '两次输入的密码不一致']
          },
          email: {
            type: ['email', '错误的 EMail 地址']
          },
          age: {
            type: ['number', '年龄只能在 18 - 28 之间'],
            custom: function(value) {
              return (value === '' || parseInt(value, 10) + '' === value && value >= 18 && value <= 28) ? '' : '年龄只能在 18 - 28 之间';
            }
          },
          games: {
          },
          colors: {
            minLength: [2, '请选择 2 项'],
            maxLength: [2, '请选择 2 项']
          },
          numbers: {
            required: [true, '必选项（被禁用的控件选定了也无效）']
          },
          description: {
            maxLength: [20, '自我介绍应限制在 20 字以内'],
            custom: function(value) {
              return value.contains(' ') ? '不能包含空格' : '';
            }
          }
        })
        .on('fieldvalidate', function(e) {
          if(e.name === 'account') {
            getMessageBox(e.name).removeClass('valid, invalid').addClass('validating');
          }
          logger.log('<em>?</em>' + e.name + ' <var>' + e.value + '</var>');
        })
        .on('fieldvalidated', function(e) {
          var passed = !e.errorMessage;
          var $td = getMessageBox(e.name);
          $td.removeClass('valid, invalid, validating').addClass(passed ? (e.value.length > 0 ? 'valid' : '') : 'invalid');
          if (!passed) {
            $td.find('.invalid')[0].innerText = e.errorMessage;
          }
          logger.log('<em>!</em>' + e.name + ' <var>' + e.value + '</var> <dfn class="' + passed + '">' + (e.errorMessage || 'passed') + '</dfn>');
        })
        .on('validate, validated', function(e) {
          logger.log('<strong>' + e.type + '</strong>' + (e.type === 'validated' ? ' <dfn class="' + e.result + '">' + e.result + '</dfn>' : ''));
        });
    /*
     logger.log('age: <var>' + $form.getFieldValue('age') + '</var>');
     logger.log('os: <var>' + $form.getFieldValue('os') + '</var>');
     logger.log('games: <var>' + $form.getFieldValue('games') + '</var>');
     logger.log('colors: <var>' + $form.getFieldValue('colors') + '</var>');
     logger.log('numbers: <var>' + $form.getFieldValue('numbers') + '</var>');
     logger.log('description: <var>' + $form.getFieldValue('description') + '</var>');
     */
    $($form.elements.account).on('change', function(e) {
      console.log(e.type, this.value);
    });

  });
  </script>

</div>
</body>
</html>
